import * as THREE from "https://cdn.jsdelivr.net";
import { OrbitControls } from "https://cdn.jsdelivr.net";

function init() {
    const container = document.getElementById("viewer");
    if (!container) {
        console.error("Помилка: Блок #viewer не знайдено!");
        return;
    }

    // Встановлюємо висоту, якщо вона не задана в CSS
    container.style.height = "500px";
    container.style.backgroundColor = "#ccc";

    // --- СЦЕНА ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xeeeeee);

    // --- КАМЕРА ---
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / 500, 1, 10000);
    camera.position.set(1500, 1000, 1500);

    // --- РЕНДЕРЕР ---
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, 500);
    container.appendChild(renderer.domElement);

    // --- УПРАВЛІННЯ (Мишка) ---
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // --- СВІТЛО ---
    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
    scene.add(light);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(1000, 1000, 1000);
    scene.add(dirLight);

    let box;

    // Отримуємо елементи UI
    const wInput = document.getElementById("w");
    const hInput = document.getElementById("h");
    const dInput = document.getElementById("d");
    const matSelect = document.getElementById("mat");

    function updateModel() {
        if (box) scene.remove(box);

        const width = parseFloat(wInput.value) || 1000;
        const height = parseFloat(hInput.value) || 2000;
        const depth = parseFloat(dInput.value) || 600;

        const geometry = new THREE.BoxGeometry(width, height, depth);
        const material = new THREE.MeshStandardMaterial({ 
            color: matSelect.value === "mdf" ? 0x8b4513 : 0xaaaaaa,
            roughness: 0.5 
        });

        box = new THREE.Mesh(geometry, material);
        box.position.y = height / 2;
        scene.add(box);

        // Оновлення тексту
        document.getElementById("wVal").textContent = width;
        document.getElementById("hVal").textContent = height;
        document.getElementById("dVal").textContent = depth;
        document.getElementById("price").textContent = Math.round((width * height * depth) / 1000000 * 5);
    }

    // Слухаємо повзунки
    [wInput, hInput, dInput, matSelect].forEach(el => {
        el.addEventListener('input', updateModel);
    });

    updateModel();

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / 500;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, 500);
    });
}

// Запуск після завантаження сторінки
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
} else {
    init();
}
